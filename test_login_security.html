<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•å®‰å…¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <h1>ğŸ” ç™»å½•å®‰å…¨æ€§æµ‹è¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h3>å½“å‰çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkCurrentState()">æ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€</button>
        <button onclick="checkTokenState()">æ£€æŸ¥TokençŠ¶æ€</button>
        <button onclick="checkLocalStorage()">æ£€æŸ¥LocalStorage</button>
        <div id="stateOutput" class="output"></div>
    </div>

    <div class="test-section">
        <h3>ç™»å½•æµ‹è¯•</h3>
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <button onclick="testLogout()">æµ‹è¯•ç™»å‡º</button>
        <div id="loginOutput" class="output"></div>
    </div>

    <div class="test-section">
        <h3>å®‰å…¨æµ‹è¯•</h3>
        <button onclick="simulateServerRestart()">æ¨¡æ‹ŸæœåŠ¡å™¨é‡å¯ï¼ˆæ¸…é™¤åç«¯çŠ¶æ€ï¼‰</button>
        <button onclick="simulateTokenExpiry()">æ¨¡æ‹ŸTokenè¿‡æœŸ</button>
        <button onclick="clearAllStorage()">æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨</button>
        <div id="securityOutput" class="output"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            container.innerHTML = `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>` + container.innerHTML;
        }

        async function checkCurrentState() {
            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${getStoredToken()}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('stateOutput', `âœ… ç”¨æˆ·å·²ç™»å½•: ${data.data.username}`, 'success');
                } else {
                    log('stateOutput', `âŒ ç”¨æˆ·æœªç™»å½•æˆ–Tokenæ— æ•ˆ: ${response.status}`, 'error');
                }
            } catch (error) {
                log('stateOutput', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function checkTokenState() {
            const token = getStoredToken();
            if (token) {
                const isExpired = checkTokenExpired(token);
                log('stateOutput', `ğŸ”‘ Tokenå­˜åœ¨ï¼Œè¿‡æœŸçŠ¶æ€: ${isExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}`, isExpired ? 'warning' : 'success');
            } else {
                log('stateOutput', 'ğŸ”‘ æ²¡æœ‰æ‰¾åˆ°Token', 'warning');
            }
        }

        function checkLocalStorage() {
            const storage = {
                'secure_auth_token': localStorage.getItem('secure_auth_token'),
                'token_version': localStorage.getItem('token_version'),
                'token_timestamp': localStorage.getItem('token_timestamp'),
                'user-store': localStorage.getItem('user-store')
            };
            
            log('stateOutput', `ğŸ“± LocalStorageçŠ¶æ€:\n${JSON.stringify(storage, null, 2)}`, 'info');
        }

        async function testLogin() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // æ¨¡æ‹Ÿå‰ç«¯å­˜å‚¨Token
                    setTestToken(data.data.access_token);
                    log('loginOutput', `âœ… ç™»å½•æˆåŠŸ: ${data.data.user.username}`, 'success');
                } else {
                    log('loginOutput', `âŒ ç™»å½•å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log('loginOutput', `âŒ ç™»å½•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testLogout() {
            try {
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getStoredToken()}`
                    }
                });

                if (response.ok) {
                    clearTestStorage();
                    log('loginOutput', 'âœ… ç™»å‡ºæˆåŠŸ', 'success');
                } else {
                    log('loginOutput', `âŒ ç™»å‡ºå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log('loginOutput', `âŒ ç™»å‡ºé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function simulateServerRestart() {
            log('securityOutput', 'ğŸ”„ æ¨¡æ‹ŸæœåŠ¡å™¨é‡å¯...', 'warning');
            log('securityOutput', 'ğŸ“ åœ¨çœŸå®æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨é‡å¯ååº”è¯¥è¦æ±‚ç”¨æˆ·é‡æ–°ç™»å½•', 'info');
            log('securityOutput', 'ğŸ” è¯·é‡æ–°æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œçœ‹æ˜¯å¦éœ€è¦é‡æ–°ç™»å½•', 'info');
        }

        function simulateTokenExpiry() {
            // ä¿®æ”¹localStorageä¸­çš„æ—¶é—´æˆ³ï¼Œä½¿Tokençœ‹èµ·æ¥è¿‡æœŸ
            const oldTimestamp = localStorage.getItem('token_timestamp');
            const expiredTimestamp = Date.now() - (9 * 60 * 60 * 1000); // 9å°æ—¶å‰
            localStorage.setItem('token_timestamp', expiredTimestamp.toString());
            
            log('securityOutput', `â° å·²å°†Tokenæ—¶é—´æˆ³ä¿®æ”¹ä¸º9å°æ—¶å‰`, 'warning');
            log('securityOutput', `ğŸ“ åŸæ—¶é—´æˆ³: ${oldTimestamp}`, 'info');
            log('securityOutput', `ğŸ“ æ–°æ—¶é—´æˆ³: ${expiredTimestamp}`, 'info');
            log('securityOutput', 'ğŸ” ç°åœ¨æ£€æŸ¥TokençŠ¶æ€åº”è¯¥æ˜¾ç¤ºä¸ºè¿‡æœŸ', 'info');
        }

        function clearAllStorage() {
            localStorage.clear();
            log('securityOutput', 'ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰LocalStorageæ•°æ®', 'success');
        }

        // è¾…åŠ©å‡½æ•°
        function getStoredToken() {
            return localStorage.getItem('secure_auth_token') || 
                   localStorage.getItem('encrypted_token') || 
                   localStorage.getItem('token') || '';
        }

        function setTestToken(token) {
            const timestamp = Date.now();
            localStorage.setItem('token', token);
            localStorage.setItem('token_timestamp', timestamp.toString());
        }

        function clearTestStorage() {
            localStorage.removeItem('token');
            localStorage.removeItem('token_timestamp');
            localStorage.removeItem('secure_auth_token');
            localStorage.removeItem('user-store');
        }

        function checkTokenExpired(token) {
            const tokenTimestamp = localStorage.getItem('token_timestamp');
            if (tokenTimestamp) {
                const timestamp = parseInt(tokenTimestamp);
                const now = Date.now();
                const tokenAge = now - timestamp;
                const maxAge = 8 * 60 * 60 * 1000; // 8å°æ—¶
                return tokenAge > maxAge;
            }
            return true;
        }
    </script>
</body>
</html>