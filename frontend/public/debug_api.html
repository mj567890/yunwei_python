<!DOCTYPE html>
<html>
<head>
    <title>前端API调试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        .error { background: #ffe6e6; border: 1px solid #ff9999; }
        .success { background: #e6ffe6; border: 1px solid #99ff99; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>前端API调试工具</h1>
    
    <h2>测试步骤</h2>
    <button onclick="testDirectAPI()">1. 直接测试API</button>
    <button onclick="testRequestUtil()">2. 测试Request工具</button>
    <button onclick="testAPIWithCORS()">3. 测试CORS</button>
    
    <div id="results"></div>

    <script>
        function log(message, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'result ' + (isError ? 'error' : 'success');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            results.appendChild(div);
        }

        // 1. 直接测试API
        async function testDirectAPI() {
            log('开始直接API测试...');
            try {
                const response = await fetch('http://localhost:5000/api/statistics/overview');
                log(`API状态码: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('API响应成功：' + JSON.stringify(data, null, 2));
                } else {
                    log(`API失败: ${response.status} ${response.statusText}`, true);
                }
            } catch (error) {
                log(`API请求异常: ${error.message}`, true);
            }
        }

        // 2. 测试前端request工具
        async function testRequestUtil() {
            log('开始测试前端Request工具...');
            try {
                // 模拟前端request工具的逻辑
                const baseURL = 'http://localhost:5000';  // 修复后的baseURL
                const url = baseURL + '/api/statistics/overview';
                log(`实际请求URL: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`Request工具状态码: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // 模拟前端的数据处理逻辑
                    if (data.success === true || data.status === 'success') {
                        log('✅ Request工具处理成功');
                        log('处理后的数据: ' + JSON.stringify({
                            success: true,
                            data: data.data
                        }, null, 2));
                    } else {
                        log('❌ 数据格式验证失败', true);
                    }
                } else {
                    log(`Request工具失败: ${response.status}`, true);
                }
            } catch (error) {
                log(`Request工具异常: ${error.message}`, true);
            }
        }

        // 3. 测试CORS
        async function testAPIWithCORS() {
            log('开始CORS测试...');
            try {
                const response = await fetch('http://localhost:5000/api/statistics/overview', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3000'
                    }
                });
                
                log(`CORS测试状态码: ${response.status}`);
                log(`CORS头信息: ${response.headers.get('Access-Control-Allow-Origin')}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('CORS测试成功: ' + JSON.stringify(data.data, null, 2));
                } else {
                    log(`CORS测试失败: ${response.status}`, true);
                }
            } catch (error) {
                log(`CORS测试异常: ${error.message}`, true);
            }
        }

        // 页面加载时自动执行基础测试
        window.onload = function() {
            log('页面加载完成，开始自动测试...');
            setTimeout(testDirectAPI, 1000);
        };
    </script>
</body>
</html>